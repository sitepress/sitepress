<% body_offset = current_page.asset.respond_to?(:body_line_offset) ? current_page.asset.body_line_offset : 1 %>
<% adjusted_line = @exception.line_number.to_i + body_offset - 1 %>
<% plain_text_error = <<~ERROR
#{@exception.class}: #{@exception.message}
File: #{current_page.asset.path}:#{adjusted_line}

Source:
#{@exception.annotated_source_code.join("\n")}

Backtrace:
#{@exception.backtrace.first(15).join("\n")}
ERROR
%>

<button onclick="navigator.clipboard.writeText(document.getElementById('error-text').textContent).then(() => this.textContent = 'Copied!').catch(() => this.textContent = 'Failed')" style="float: right; padding: 8px 16px; cursor: pointer; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: inherit; border-radius: 4px; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.1)'; this.style.borderColor='rgba(255,255,255,0.5)'" onmouseout="this.style.background='transparent'; this.style.borderColor='rgba(255,255,255,0.3)'">Copy Error</button>
<pre id="error-text" style="display: none;"><%= plain_text_error %></pre>

<h2><%= @exception.class %>: <%= @exception.message %> in <%= current_page.asset.path %>:<%= adjusted_line %></h2>
<h3>Source</h3>

<code>
  <pre><%= current_page.asset.path %>:<%= adjusted_line %>
<%= @exception.annotated_source_code.join("\n") %></pre>
</code>

<%
  # Clean up ugly ERB-generated method names in stack traces
  clean_trace = ->(line) {
    if line =~ /\.erb:\d+:in '___/
      line.sub(/:in '___.*'$/, '')
    else
      line
    end
  }
  app_trace = @exception.backtrace.reject { |line| line.include?('/gems/') || line.include?('/ruby/') }.map(&clean_trace)
  framework_trace = @exception.backtrace.select { |line| line.include?('/gems/') || line.include?('/ruby/') }.map(&clean_trace)
%>

<h3>Backtrace</h3>
<code>
  <pre style="margin: 0;"><%= app_trace.first(10).join("\n") %></pre>
  <% if framework_trace.any? %>
  <details style="margin-top: 1em;">
    <summary style="cursor: pointer; font-size: 0.85em; padding: 0.5em 0; border-top: 1px solid rgba(255,255,255,0.15); user-select: none; display: flex; align-items: center; gap: 0.5em; opacity: 0.7;">
      <span style="display: inline-block; transition: transform 0.2s ease;">â–¶</span>
      Framework Trace (<%= framework_trace.length %> lines)
    </summary>
    <pre style="margin: 0.5em 0 0 0;"><%= framework_trace.join("\n") %></pre>
  </details>
  <% end %>
</code>
<style>
  details[open] summary span { transform: rotate(90deg) !important; }
  details summary::-webkit-details-marker { display: none; }
  details summary::marker { display: none; }
</style>

<h3>Resources</h3>
<table>
  <thead>
    <th>Request path</th>
    <th>Asset path</th>
    <th>Media type</th>
  </thead>
  <tbody>
    <% site.resources.each do |resource| %>
      <tr>
        <td><%= link_to resource.request_path, resource.request_path %></td>
        <td><%= resource.asset.path %></td>
        <td><%= resource.asset.mime_type %></td>
      </tr>
    <% end %>
  </tbody>
</table>
